# Terraform Provider CI/CD Pipeline
image: golang:1.22

definitions:
  steps:
    - step: &release
        name: Release with GoReleaser
        script:
          # Install GoReleaser
          - curl -sfL https://goreleaser.com/static/run | bash -s -- --version
          - curl -sfL https://goreleaser.com/static/run | bash -s -- release --clean
        artifacts:
          - dist/**

pipelines:
  # Trigger on version tags (e.g., v0.1.0, v1.2.3)
  tags:
    'v*':
      - step: *release
        name: Release on version tag
        deployment: production
        script:
          # Fetch all tags and history for GoReleaser
          - git fetch --tags --unshallow || git fetch --tags

          # Import GPG key for signing
          - apt-get update && apt-get install -y gnupg
          - echo "$GPG_PRIVATE_KEY" | gpg --import --batch --yes

          # Install GoReleaser
          - curl -sfL https://install.goreleaser.com/github.com/goreleaser/goreleaser.sh | sh

          # Run GoReleaser
          - ./bin/goreleaser release --clean
        artifacts:
          - dist/**
